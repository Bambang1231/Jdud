<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM DISIPLIN MILITER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #ff0000;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        body.late {
            background: #1a0000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { background: #1a0000; }
            50% { background: #3a0000; }
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 48px;
            font-weight: bold;
            letter-spacing: 5px;
            text-shadow: 0 0 20px #ff0000;
        }

        .current-time {
            font-size: 24px;
            color: #00ff00;
            margin: 10px 0;
        }

        .main-display {
            background: #1a1a1a;
            border: 3px solid #ff0000;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            min-width: 600px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }

        .countdown {
            font-size: 72px;
            font-weight: bold;
            color: #00ff00;
            margin: 20px 0;
            text-shadow: 0 0 10px #00ff00;
        }

        .countdown.warning {
            color: #ffaa00;
        }

        .countdown.danger {
            color: #ff0000;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .status {
            font-size: 32px;
            margin: 20px 0;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-info {
            font-size: 24px;
            color: #ffffff;
            margin: 15px 0;
            padding: 15px;
            background: #2a2a2a;
            border-left: 5px solid #ff0000;
        }

        .btn {
            background: #ff0000;
            color: #ffffff;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #cc0000;
            box-shadow: 0 0 20px #ff0000;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .schedule-list {
            margin: 20px 0;
            text-align: left;
        }

        .schedule-item {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-left: 5px solid #666;
        }

        .schedule-item.active {
            border-left-color: #ff0000;
            background: #3a1a1a;
        }

        .schedule-item.completed {
            border-left-color: #00ff00;
            opacity: 0.6;
        }

        .late-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff0000;
            color: #000;
            padding: 20px;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .report {
            background: #1a1a1a;
            padding: 30px;
            border: 3px solid #00ff00;
            max-width: 800px;
        }

        .report h2 {
            color: #00ff00;
            margin-bottom: 20px;
        }

        .report-item {
            padding: 10px;
            margin: 10px 0;
            background: #2a2a2a;
        }

        .setup {
            background: #1a1a1a;
            padding: 30px;
            border: 3px solid #ff0000;
            max-width: 600px;
        }

        .setup input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #2a2a2a;
            border: 2px solid #666;
            color: #fff;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        .volume-indicator {
            font-size: 18px;
            color: #ffaa00;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="setup">
            <h2>INISIALISASI SISTEM DISIPLIN</h2>
            <div style="margin: 20px 0;">
                <label style="color: #fff; display: block; margin: 10px 0;">JAM ISTIRAHAT (HH:MM)</label>
                <input type="time" id="breakTime" value="12:00">
            </div>
            <div style="margin: 20px 0;">
                <label style="color: #fff; display: block; margin: 10px 0;">JADWAL OPERASI (Format: HH:MM-HH:MM Nama Tugas)</label>
                <input type="text" placeholder="08:00-09:00 Fokus Kerja" id="task1" value="08:00-09:00 Fokus Kerja">
                <input type="text" placeholder="09:00-10:00 Belajar" id="task2" value="09:00-10:00 Belajar">
                <input type="text" placeholder="10:00-11:00 Eksekusi" id="task3" value="10:00-11:00 Eksekusi">
                <input type="text" placeholder="11:00-12:00 Finalisasi" id="task4" value="11:00-12:00 Finalisasi">
            </div>
            <button class="btn" onclick="initializeSystem()">AKTIVASI SISTEM</button>
        </div>

        <!-- Main Screen -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <h1>⚠ SISTEM DISIPLIN MILITER ⚠</h1>
                <div class="current-time" id="currentTime"></div>
            </div>

            <div class="main-display">
                <div class="status" id="status">STANDBY</div>
                <div class="countdown" id="countdown">00:00:00</div>
                <div class="task-info" id="taskInfo">MENUNGGU JAM OPERASI...</div>
                <div class="volume-indicator" id="volumeIndicator"></div>
                <button class="btn" id="completeBtn" onclick="completeTask()" style="display: none;">SELESAI TUGAS</button>
            </div>

            <div class="schedule-list" id="scheduleList"></div>
        </div>

        <!-- Report Screen -->
        <div id="reportScreen" class="hidden">
            <div class="report">
                <h2>LAPORAN DISIPLIN HARIAN</h2>
                <div id="reportContent"></div>
                <button class="btn" onclick="resetSystem()" style="margin-top: 20px;">RESET SISTEM</button>
            </div>
        </div>

        <!-- Late Warning -->
        <div id="lateWarning" class="late-warning hidden">
            ⚠ KAMU TELAT! SELESAIKAN TUGAS SEKARANG! ⚠
        </div>
    </div>

    <!-- Audio untuk alarm -->
    <audio id="alarmSound" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVqzn7K1aFgxDm9/vxXMpBSt9zPLaizsIGGS37OihUQ4KTKXh8a9hGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGgU7k9b0yoE0Bx9vu+7mnEgMDlOq5O+zYBoFPJXY88eBNQcfb7zv5ppHDAxPpuPwtGIbBT2W2fPJgDQHH26+7uWbSA0OUqfk7rFgGg==" type="audio/wav">
    </audio>

    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'MilitaryTimeDB';
        const DB_VERSION = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('schedule')) {
                        db.createObjectStore('schedule', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('logs')) {
                        db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('config')) {
                        db.createObjectStore('config', { keyPath: 'key' });
                    }
                };
            });
        }

        function saveToDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFromDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function updateInDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function clearDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Global Variables
        let schedule = [];
        let currentTaskIndex = -1;
        let isLate = false;
        let lateSeconds = 0;
        let breakTime = '12:00';
        let alarmVolume = 1.0;
        let systemActive = false;

        // Initialize System
        async function initializeSystem() {
            await initDB();
            
            // Parse schedule
            schedule = [];
            for (let i = 1; i <= 4; i++) {
                const input = document.getElementById(`task${i}`).value.trim();
                if (input) {
                    const match = input.match(/(\d{2}:\d{2})-(\d{2}:\d{2})\s+(.+)/);
                    if (match) {
                        schedule.push({
                            startTime: match[1],
                            endTime: match[2],
                            name: match[3],
                            completed: false
                        });
                    }
                }
            }

            breakTime = document.getElementById('breakTime').value;

            // Save to IndexedDB
            await clearDB('schedule');
            await clearDB('config');
            
            for (let task of schedule) {
                await saveToDB('schedule', task);
            }
            await saveToDB('config', { key: 'breakTime', value: breakTime });

            // Show main screen
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');

            displaySchedule();
            requestFullscreen();
            startSystem();
        }

        function displaySchedule() {
            const list = document.getElementById('scheduleList');
            list.innerHTML = '<h3 style="color: #fff; margin-bottom: 15px;">JADWAL OPERASI:</h3>';
            
            schedule.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = 'schedule-item';
                div.id = `task-${index}`;
                div.innerHTML = `
                    <strong>${task.startTime} - ${task.endTime}</strong><br>
                    ${task.name}<br>
                    <span style="color: ${task.completed ? '#00ff00' : '#666'};">
                        ${task.completed ? '✓ SELESAI' : '○ MENUNGGU'}
                    </span>
                `;
                list.appendChild(div);
            });
        }

        function startSystem() {
            systemActive = true;
            setInterval(updateSystem, 1000);
            
            // Monitor fullscreen
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        }

        function updateSystem() {
            const now = new Date();
            const currentTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const currentSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            
            // Update current time display
            document.getElementById('currentTime').textContent = 
                `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

            // Check if break time reached
            const breakSeconds = timeToSeconds(breakTime);
            if (currentSeconds >= breakSeconds) {
                showReport();
                return;
            }

            // Find current task
            let foundTask = false;
            for (let i = 0; i < schedule.length; i++) {
                const task = schedule[i];
                const startSeconds = timeToSeconds(task.startTime);
                const endSeconds = timeToSeconds(task.endTime);

                if (currentSeconds >= startSeconds && currentSeconds < endSeconds) {
                    foundTask = true;
                    
                    if (currentTaskIndex !== i) {
                        currentTaskIndex = i;
                        isLate = false;
                        lateSeconds = 0;
                        updateTaskDisplay();
                    }

                    // Calculate remaining time
                    const remaining = endSeconds - currentSeconds;
                    updateCountdown(remaining);

                    // Check if late (task should have been completed)
                    if (!task.completed) {
                        if (remaining < (endSeconds - startSeconds) * 0.9) {
                            if (!isLate) {
                                isLate = true;
                                startAlarm();
                            }
                            lateSeconds++;
                            updateAlarmIntensity();
                        }
                    } else {
                        stopAlarm();
                        isLate = false;
                    }

                    break;
                }
            }

            if (!foundTask && currentSeconds >= timeToSeconds(schedule[0].startTime)) {
                // Between tasks - still enforce discipline
                document.getElementById('status').textContent = 'TRANSISI - SIAP UNTUK TUGAS BERIKUTNYA';
                document.getElementById('taskInfo').textContent = 'BERSIAP...';
            }
        }

        function updateTaskDisplay() {
            const task = schedule[currentTaskIndex];
            document.getElementById('status').textContent = 'JALANKAN TUGAS SEKARANG!';
            document.getElementById('taskInfo').textContent = task.name.toUpperCase();
            document.getElementById('completeBtn').style.display = 'block';
            
            // Highlight current task
            document.querySelectorAll('.schedule-item').forEach((el, i) => {
                el.classList.remove('active');
                if (i === currentTaskIndex) el.classList.add('active');
            });
        }

        function updateCountdown(seconds) {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = `${pad(hours)}:${pad(mins)}:${pad(secs)}`;
            
            // Change color based on time
            countdownEl.classList.remove('warning', 'danger');
            if (seconds < 300) countdownEl.classList.add('danger');
            else if (seconds < 600) countdownEl.classList.add('warning');
        }

        function startAlarm() {
            const alarm = document.getElementById('alarmSound');
            alarm.volume = 1.0;
            alarm.play().catch(e => console.log('Alarm play failed:', e));
            
            document.getElementById('lateWarning').classList.remove('hidden');
            document.body.classList.add('late');
        }

        function stopAlarm() {
            const alarm = document.getElementById('alarmSound');
            alarm.pause();
            alarm.currentTime = 0;
            
            document.getElementById('lateWarning').classList.add('hidden');
            document.body.classList.remove('late');
            document.getElementById('volumeIndicator').textContent = '';
        }

        function updateAlarmIntensity() {
            // Increase volume every 30 seconds of being late
            const volumeMultiplier = 1 + Math.floor(lateSeconds / 30) * 0.1;
            alarmVolume = Math.min(volumeMultiplier, 2.0);
            
            const alarm = document.getElementById('alarmSound');
            alarm.volume = 1.0; // Keep at max
            alarm.playbackRate = Math.min(volumeMultiplier, 1.5);
            
            document.getElementById('volumeIndicator').textContent = 
                `⚠ ALARM LEVEL: ${Math.floor(volumeMultiplier * 100)}%`;
        }

        async function completeTask() {
            if (currentTaskIndex === -1) return;
            
            const task = schedule[currentTaskIndex];
            task.completed = true;
            
            // Update in DB
            await updateInDB('schedule', { ...task, id: currentTaskIndex + 1 });
            
            // Log completion
            await saveToDB('logs', {
                taskName: task.name,
                completedAt: new Date().toISOString(),
                wasLate: isLate,
                lateBySeconds: isLate ? lateSeconds : 0
            });
            
            stopAlarm();
            isLate = false;
            lateSeconds = 0;
            
            document.getElementById(`task-${currentTaskIndex}`).classList.add('completed');
            document.getElementById('completeBtn').style.display = 'none';
            document.getElementById('status').textContent = 'TUGAS SELESAI - STANDBY';
        }

        async function showReport() {
            systemActive = false;
            stopAlarm();
            
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('reportScreen').classList.remove('hidden');
            
            const logs = await getAllFromDB('logs');
            const reportContent = document.getElementById('reportContent');
            
            let onTime = 0;
            let late = 0;
            let totalLateSeconds = 0;
            
            let html = '<h3 style="color: #fff;">STATISTIK HARI INI:</h3>';
            
            logs.forEach(log => {
                if (log.wasLate) {
                    late++;
                    totalLateSeconds += log.lateBySeconds;
                } else {
                    onTime++;
                }
                
                html += `
                    <div class="report-item">
                        <strong style="color: ${log.wasLate ? '#ff0000' : '#00ff00'};">
                            ${log.wasLate ? '✗ TELAT' : '✓ TEPAT WAKTU'}
                        </strong><br>
                        ${log.taskName}<br>
                        ${log.wasLate ? `Terlambat: ${Math.floor(log.lateBySeconds / 60)} menit ${log.lateBySeconds % 60} detik` : ''}
                    </div>
                `;
            });
            
            html = `
                <div class="report-item" style="background: #1a3a1a; border: 2px solid #00ff00;">
                    <strong style="color: #00ff00; font-size: 24px;">TEPAT WAKTU: ${onTime}</strong>
                </div>
                <div class="report-item" style="background: #3a1a1a; border: 2px solid #ff0000;">
                    <strong style="color: #ff0000; font-size: 24px;">TERLAMBAT: ${late}</strong>
                </div>
                <div class="report-item">
                    Total Keterlambatan: ${Math.floor(totalLateSeconds / 60)} menit
                </div>
            ` + html;
            
            reportContent.innerHTML = html;
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        async function resetSystem() {
            await clearDB('schedule');
            await clearDB('logs');
            await clearDB('config');
            
            location.reload();
        }

        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            }
        }

        function handleFullscreenChange() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (systemActive && currentTaskIndex !== -1) {
                    // User exited fullscreen during active task - trigger alarm
                    if (!isLate) {
                        isLate = true;
                        startAlarm();
                    }
                    
                    // Try to re-enter fullscreen
                    setTimeout(requestFullscreen, 100);
                }
            }
        }

        // Utility Functions
        function timeToSeconds(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 3600 + minutes * 60;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        // Prevent page unload during active session
        window.addEventListener('beforeunload', (e) => {
            if (systemActive) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Initialize on load
        window.addEventListener('load', async () => {
            await initDB();
            
            // Check if there's existing config
            const configs = await getAllFromDB('config');
            const scheduleData = await getAllFromDB('schedule');
            
            if (configs.length > 0 && scheduleData.length > 0) {
                // Resume existing session
                const breakConfig = configs.find(c => c.key === 'breakTime');
                if (breakConfig) breakTime = breakConfig.value;
                
                schedule = scheduleData;
                
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('mainScreen').classList.remove('hidden');
                
                displaySchedule();
                requestFullscreen();
                startSystem();
            }
        });
    </script>
</body>
</html